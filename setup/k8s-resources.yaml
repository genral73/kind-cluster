apiVersion: v1
kind: Namespace
metadata:
  name: k8s-resources
  labels:
    environment: k8s-cluster
---
apiVersion: v1
kind: Secret
data:
  password: Z2hwX1E5cmVCalVsWXkzNHJaZ2M4TXVPMk4wSFBMWWpNRDRib05sZw==
  username: Z2VucmFsNzM=
metadata:
  name: github-reg-cred
  namespace: argocd
type: Opaque
---
apiVersion: v1
kind: Secret
data:
  password: RE9kbzA5MDk2OTk1MTU=
  username: Z2VucmFsNzM=
metadata:
  name: gitlab-reg-cred
  namespace: argocd
type: Opaque
---
apiVersion: v1
kind: ResourceQuota
metadata:
  name: k8s-resources-resources-quota
  namespace: k8s-resources
spec:
  hard:
    limits.cpu: "4000m"
    limits.memory: 12Gi
    count/pods: "32"
    count/services: "16"
    count/secrets: "16"
    count/configmaps: "16"
    count/deployments.apps: "16"
    count/replicasets.apps: "16"
    count/statefulsets.apps: "16"
    count/jobs.batch: "16"
    count/cronjobs.batch: "16"
    count/deployments.extensions: "16"
---
apiVersion: v1
kind: LimitRange
metadata:
  name: k8s-resources-limit-range
  namespace: k8s-resources
spec:
  limits:
  - default:
      memory: 264Mi
      cpu: 200m
    defaultRequest:
      memory: 128Mi
      cpu: 100m
    type: Container
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: default
  namespace: k8s-resources
imagePullSecrets:
- name: github-reg-cred
- name: gitlab-reg-cred
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: k8s-resources-root-psp
  labels:
    addonmanager.kubernetes.io/mode: EnsureExists
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: psp:restricted
subjects:
- kind: ServiceAccount
  name: default
  namespace: k8s-resources
---
# apiVersion: rbacmanager.reactiveops.io/v1beta1
# kind: RBACDefinition
# metadata:
#   name: k8s-resources-app-operators
# rbacBindings:
#   - name: users
#     subjects:
#       - kind: User
#         name: "dafaallah"
#     roleBindings:
#       - namespace: "k8s-resources"
#         clusterRole: app-operator
# ---
apiVersion: argoproj.io/v1alpha1
kind: AppProject
metadata:
  name: k8s-resources
  namespace: argocd
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  description: k8s Cluster Project
  sourceRepos:
  - '*'
  destinations:
  - namespace: k8s-resources
    server: https://kubernetes.default.svc

  clusterResourceWhitelist:
  - group: '*'
    kind: '*'
  # namespaceResourceBlacklist:
  # - group: ''
  #   kind: ResourceQuota
  # - group: ''
  #   kind: LimitRange
  # - group: ''
  #   kind: NetworkPolicy
  namespaceResourceWhitelist:
  - group: '*'
    kind: '*'
#  - group: 'apps'
#    kind: StatefulSet
  orphanedResources:
    warn: false
  roles:
  - name: k8s-operator
    description: Read-only privileges to k8s-resources
    policies:
    - p, proj:k8s-resources:k8s-operator, applications, *, k8s-resources/*, allow
    groups:
    - dafaallah
    - admin
    jwtTokens:
    - iat: 1604331144
      id: 6c276c70-0f97-4d22-aac9-20123242e25c
---      
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: k8s-tools
  namespace: argocd
spec:
  project: default
  source:
    repoURL: 'https://github.com/genral73/k8s-kind.git'
    path: k8s-resources/tools
    targetRevision: HEAD
  destination:
    server: 'https://kubernetes.default.svc'
    namespace: k8s-resources
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: k8s-namespaces
  namespace: argocd
spec:
  project: default
  source:
    repoURL: 'https://github.com/genral73/k8s-kind.git'
    path: k8s-resources/namespaces
    targetRevision: HEAD
  destination:
    server: 'https://kubernetes.default.svc'
    namespace: k8s-resources
  syncPolicy:
    automated:
      prune: true
      selfHeal: true        